<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mch</title>
  <!-- ä½¿ç”¨å°ç«è½¦ emoji ä½œä¸º favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš‚</text></svg>">
  <link rel="stylesheet" href="css/style.css">
  <script src="img/images.js"></script> <!-- Load image manifest before main script -->
  <style>
    /* å…¨å±æ–‡è‰ºæŸ”å’Œé£æ ¼è¦†ç›–æ ·å¼ */
    :root {
        /* æŸ”å’Œçš„è«å…°è¿ªè‰²ç³» / çº¸å¼ è´¨æ„Ÿé…è‰² */
        --bg-color: #f5f2e9;   /* ç±³ç™½/æš–ç°ï¼Œåƒæ—§ä¹¦é¡µ */
        --text-color: #4a4a4a; /* æ·±ç°ï¼Œä¸å¦‚çº¯é»‘åˆºçœ¼ */
        --accent-color: #8c9ea3; /* ç°è“ï¼Œä½é¥±å’Œåº¦ */
        --border-color: #e0ddd5;
        --nav-hover: #6b7c85;
    }

    body {
        font-family: "Optima", "Palatino", "Georgia", serif; /* ä¼˜é›…çš„è¡¬çº¿/äººæ–‡ä¸»ä¹‰æ— è¡¬çº¿å­—ä½“ */
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
        display: flex;
        flex-direction: column;
        justify-content: space-between; /* å‚ç›´åˆ†å¸ƒï¼šå¤´-ä¸­-è„š */
    }
    
    /* é¡¶éƒ¨å¸ƒå±€ï¼šç´§å‡‘ä¸”ä¼˜é›… */
    header {
        padding: 1.5rem 2rem;
        display: flex;
        justify-content: space-between; /* å·¦å³åˆ†å¼€ */
        align-items: center;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        border-bottom: 1px solid transparent; /* ç§»é™¤åŸæ¥çš„è¾¹æ¡†æ„Ÿ */
        flex: 0 0 auto; /* ä¸ä¼¸ç¼© */
    }
    
    .logo {
        font-family: "Playfair Display", serif;
        font-size: 2rem;
        font-weight: 700;
        color: #2c3e50;
        letter-spacing: 0.05em;
        margin: 0;
    }
    
    /* ç§»é™¤ä¹‹å‰çš„è£…é¥°çº¿ */
    .logo::after { display: none; }

    nav {
        display: flex;
        gap: 2rem;
    }

    nav a {
        color: var(--accent-color);
        font-size: 0.95rem;
        font-weight: 500;
        text-transform: capitalize; /* é¦–å­—æ¯å¤§å†™ï¼Œæ¯”å…¨å¤§å†™æ›´æŸ”å’Œ */
        letter-spacing: 0.05em;
        text-decoration: none;
        transition: all 0.3s ease;
        position: relative;
        margin: 0;
    }

    nav a:hover {
        color: var(--nav-hover);
    }
    
    /* ç®€å•çš„ä¸‹åˆ’çº¿åŠ¨æ•ˆ */
    nav a::after {
        content: '';
        position: absolute;
        width: 0;
        height: 1px;
        bottom: -4px;
        left: 0;
        background-color: var(--nav-hover);
        transition: width 0.3s ease;
    }
    nav a:hover::after {
        width: 100%;
    }
    
    /* æ ¸å¿ƒèˆå°ï¼šç»å¯¹å±…ä¸­ */
    .train-stage {
        flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
        margin: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: auto; /* é‡ç½®æœ€å°é«˜åº¦ */
        opacity: 0.95; /* å¾®é€æ„Ÿ */
    }
    
    /* èƒ¶ç‰‡æ¡†ä½“æ ·å¼è°ƒæ•´ - èå…¥æµ…è‰²èƒŒæ™¯ */
    .film-strip {
        box-shadow: 0 20px 60px rgba(0,0,0,0.15); /* æ›´è½»æŸ”çš„é˜´å½± */
        border: 8px solid #333; /* åƒä¸€ä¸ªç›¸æ¡† */
        background: #222;
        /* ä¿æŒä¹‹å‰çš„ç¼©æ”¾ï¼Œä½†å¯èƒ½éœ€è¦æ ¹æ®å±å¹•å¾®è°ƒï¼Œæš‚æ—¶ä¿æŒ 1.5 */
        transform: scale(1.3); /* ç¨å¾®è°ƒå°ä¸€ç‚¹ä»¥å…æ’‘ç ´å°å±å¹• */
    }
    
    /* åº•éƒ¨ä¿¡æ¯ */
    .footnote {
        border-top: none;
        text-align: center;
        font-size: 0.8rem;
        color: #999;
        padding: 1rem;
        margin: 0;
        flex: 0 0 auto;
    }
    
    .footnote a {
        color: #888;
        text-decoration: none;
        transition: color 0.2s;
    }
    .footnote a:hover { color: var(--nav-hover); }

    /* èƒŒæ™¯é£æ™¯å®¹å™¨ */
    .scenery-container {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      overflow: hidden;
      z-index: 0; 
    }

    .scenery-item {
      position: absolute;
      top: 0; left: 0;
      /* ç§»é™¤å›ºå®šå®½åº¦ï¼Œç”±å†…å®¹(å›¾ç‰‡)å†³å®šå®½åº¦ */
      height: 100%;
      will-change: transform;
    }

    /* ç§»é™¤ä¹‹å‰çš„ keyframes å®šä¹‰ */

    .scenery-item img {
      display: block;
      /* å¼ºåˆ¶é«˜åº¦å¡«æ»¡ï¼Œå®½åº¦è‡ªé€‚åº”ï¼Œä¿è¯å›¾ç‰‡æŒ‰åŸæ¯”ä¾‹å®Œå…¨æ˜¾ç¤º */
      height: 100%;
      width: auto;
      max-width: none; /* é˜²æ­¢è¢«çˆ¶å®¹å™¨é™åˆ¶ */
    }

    /* å“åº”å¼å¾®è°ƒ */
    @media (max-height: 800px) {
        .film-strip { transform: scale(1.1); }
        .logo { font-size: 1.5rem; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Mch</div>
    <nav>
      <a href="/">Home</a>
      <a href="article/">Articles</a>
      <a href="#about">About</a>
    </nav>
  </header>

  <section class="train-stage">
    <div class="film-strip">
      <div class="film-screen">
        <div class="scenery-container"></div>
        <div class="train-wrapper">
          <div class="train">
            <div class="train-cabin">
                <div class="train-window"></div>
            </div>
            <div class="train-body"></div>
            <div class="train-plate"></div>
            <div class="train-chimney"></div>
            <div class="train-cowcatcher"></div>
            <div class="train-chassis"></div>
            
            <div class="train-wheel w1"></div>
            <div class="train-wheel w2"></div>
            <div class="train-wheel w3"></div>

            <div class="smoke s1"></div>
            <div class="smoke s2"></div>
          </div>
          
          <div class="train-link"></div>
          
          <div class="train-carriage">
              <div class="carriage-body"></div>
              <div class="carriage-window cw1"></div>
              <div class="carriage-window cw2"></div>
              <div class="carriage-window cw3"></div>
              <div class="carriage-wheel w1"></div>
              <div class="carriage-wheel w2"></div>
          </div>
        </div>
        <div class="track"></div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      /* Train Logic Disabled
      // --- Train Logic Restored ---
      const wrapper = document.querySelector('.train-wrapper');
      
      // Initial offset for the first added carriage
      // Static Car 1 starts at 305px.
      // Gap logic (25px gap): 
      // Step = Body(220) + Gap(25) = 245.
      // Next Car Pos = 305 + 245 = 550.
      let lastRightPos = 550; 

      function addCarriage() {
         // Create Link
         const link = document.createElement('div');
         link.className = 'train-link';
         // Link needs to overlap previous body by 10px.
         // Link Width 45. Gap 25. Overlap Next 10.
         // Relative to Next Car (lastRightPos): -35px.
         link.style.left = (lastRightPos - 35) + 'px'; 
         wrapper.appendChild(link);

         // Create Carriage
         const carriage = document.createElement('div');
         carriage.className = 'train-carriage';
         carriage.style.left = lastRightPos + 'px';
         
         carriage.innerHTML = `
              <div class="carriage-body"></div>
              <div class="carriage-window cw1"></div>
              <div class="carriage-window cw2"></div>
              <div class="carriage-window cw3"></div>
              <div class="carriage-wheel w1"></div>
              <div class="carriage-wheel w2"></div>
         `;
         wrapper.appendChild(carriage);

         // Update position for next one
         // Body(220) + Gap(25) = 245
         lastRightPos += 245; 
         
         // Limiter to prevent infinite DOM growth invisible off-screen
         if (wrapper.children.length > 20) {
             // Just stop adding or remove old? 
             // Since they grow to the left (negative visual space), 
             // eventually they are far off screen.
             // We can just keep adding or better, stop adding after some length.
             // But user likes infinite train. Let's keep adding but maybe remove?
             // Removing from DOM changes index. Logic relies on append.
             // Let's just limit to 20 carriages for performance, it's enough visual fill.
             // Actually, if we stop adding, the "shake" animation continues.
             // Let's just keep adding for now, it's a toy.
         }
      }

      // Initial carriages
      for (let i = 0; i < 3; i++) {
          addCarriage();
      }

      // Continue adding
      setInterval(addCarriage, 2000);
      */

      // --- Stations & Scenery Logic ---
      const filmScreen = document.querySelector('.film-screen');
      
      // Generate 35 images: shanhai_1.jpg to shanhai_35.jpg
      /* Hardcoded list generation removed
      const allImages = [];
      for(let i=1; i<=35; i++) {
        allImages.push(`img/shanhai_${i}.jpg`);
      }
      */
      
      let allImages = [];

      // Image selection logic
      let recentImages = []; 
      
      function getNextImage() {
          if (allImages.length === 0) return ''; 

          let randomIndex;
          let attempts = 0;
          
          do {
             randomIndex = Math.floor(Math.random() * allImages.length);
             attempts++;
          } while (recentImages.includes(randomIndex) && attempts < 100);
          
          recentImages.push(randomIndex);
          if (recentImages.length > 10) recentImages.shift(); 
          
          return allImages[randomIndex];
      }

      // --- Seamless Scenery Logic (Queue Based) ---
      // é‡æ„é€»è¾‘ï¼šåŸºäºé˜Ÿåˆ—çš„åŠ¨æ€å®½åº¦æ‹¼æ¥ï¼Œæ”¯æŒä»»æ„æ¯”ä¾‹å›¾ç‰‡æ— ç¼æ»šåŠ¨
      
      const sceneryContainer = document.querySelector('.scenery-container');
      const CONTAINER_HEIGHT = 280; // è§†çª—é«˜åº¦
      const VIEWPORT_WIDTH = 640;   // è§†çª—å®½åº¦
      
      let activeItems = []; // å­˜æ”¾å½“å‰å±å¹•ä¸Šçš„å›¾å— { element, x, width }
      let tailX = 0;        // é˜Ÿå°¾ä½ç½®ï¼ˆä¸‹ä¸€å¼ å›¾æ’å…¥çš„èµ·å§‹Xåæ ‡ï¼‰
      let running = false;
      
      // é€Ÿåº¦è®¾ç½®ï¼šåƒç´ /æ¯«ç§’
      // ä¹‹å‰æ˜¯ 640px/5000ms = 0.128 px/ms
      const speed = 0.12; // è°ƒå¿«ä¸€ç‚¹

      // å›¾ç‰‡é¢„åŠ è½½é˜Ÿåˆ—ï¼Œç¡®ä¿è¯æ— ç¼æ‹¼æ¥
      const imageQueue = [];
      const MIN_QUEUE_SIZE = 3;

      // è¾…åŠ©ï¼šåŠ è½½å›¾ç‰‡å¹¶è·å–å°ºå¯¸
      function loadImageAsync(src) {
          return new Promise((resolve, reject) => {
              const img = new Image();
              img.onload = () => resolve(img);
              img.onerror = () => reject(new Error(`Failed to load ${src}`));
              img.src = src;
          });
      }

      // å¡«å……é¢„åŠ è½½é˜Ÿåˆ—
      async function fillQueue() {
          while (imageQueue.length < MIN_QUEUE_SIZE) {
               const src = getNextImage();
               if (!src) break;
               
               try {
                   const img = await loadImageAsync(src);
                   imageQueue.push(img);
               } catch (e) {
                   console.warn(e);
                   // å¤±è´¥åˆ™ç¨åé‡è¯•æˆ–è·³è¿‡
                   await new Promise(r => setTimeout(r, 100));
               }
          }
      }

      // æ·»åŠ ä¸‹ä¸€å¼ å›¾åˆ°èˆå°
      function addNextItem() {
          if (imageQueue.length === 0) {
              // é˜Ÿåˆ—ç©ºäº†ï¼Œå¼ºåˆ¶åŠ è½½ä¸€ä¸ªï¼ˆå¯èƒ½ä¼šæœ‰ä¸€ç¬é—´ç©ºç™½ï¼Œä½† fillQueue ä¼šå°½å¿«è¡¥ä¸Šï¼‰
              fillQueue();
              return;
          }

          const imgObj = imageQueue.shift();
          fillQueue(); // æ¶ˆè´¹äº†ä¸€ä¸ªï¼Œèµ¶ç´§è¡¥
          
          // è®¡ç®—æ¸²æŸ“å®½åº¦ (ä¿æŒåŸæ¯”ä¾‹)
          const aspect = imgObj.naturalWidth / imgObj.naturalHeight;
          const renderWidth = CONTAINER_HEIGHT * aspect;

          const div = document.createElement('div');
          div.className = 'scenery-item';
          div.appendChild(imgObj); // ç›´æ¥ä½¿ç”¨é¢„åŠ è½½å¥½çš„ img å…ƒç´ 
          
          // åˆå§‹ä½ç½®
          div.style.transform = `translate3d(${tailX}px, 0, 0)`;
          
          sceneryContainer.appendChild(div);

          activeItems.push({
              el: div,
              x: tailX,
              width: renderWidth
          });

          // æ›´æ–°é˜Ÿå°¾ä½ç½®
          tailX += renderWidth;
      }

      let lastTime = 0;
      function loop(timestamp) {
          if (!lastTime) lastTime = timestamp;
          let dt = timestamp - lastTime;
          lastTime = timestamp;

          // é¿å…åˆ‡æ¢ tab å dt è¿‡å¤§å¯¼è‡´è·³è·ƒ
          if (dt > 50) dt = 50;

          const move = speed * dt;

          // 1. ç§»åŠ¨ç°æœ‰å…ƒç´ 
          for (let i = 0; i < activeItems.length; i++) {
              const item = activeItems[i];
              item.x -= move;
              item.el.style.transform = `translate3d(${item.x.toFixed(2)}px, 0, 0)`;
          }

          // 2. æ›´æ–°é˜Ÿå°¾æŒ‡é’ˆ (å®ƒéšæ•´ä½“å·¦ç§»)
          tailX -= move;

          // 3. ç§»é™¤å·²å®Œå…¨ç¦»å¼€å·¦ä¾§å±å¹•çš„å…ƒç´  (åŠ ä¸Šä¸€ç‚¹ç¼“å†²åŒº 50px)
          if (activeItems.length > 0) {
              const firstItem = activeItems[0];
              if (firstItem.x + firstItem.width < -50) {
                  firstItem.el.remove();
                  activeItems.shift();
              }
          }

          // 4. æ£€æŸ¥æ˜¯å¦éœ€è¦åœ¨å³ä¾§è¡¥å……æ–°å…ƒç´ 
          // å¦‚æœé˜Ÿå°¾å·²ç»è¿›å…¥ "å³å°†æ˜¾ç¤ºåŒºåŸŸ" (æ¯”å¦‚è§†çª—å³ä¾§å†…æˆ–ç¨å¾®å‡ºå»ä¸€ç‚¹)
          if (tailX < VIEWPORT_WIDTH + 100) {
              addNextItem();
          }

          requestAnimationFrame(loop);
      }

      // Initialize Logic
      async function initScenery() {
          // Try to get images from global variable set by images.js
          if (window.manifestImages && window.manifestImages.length > 0) {
              allImages = window.manifestImages;
              console.log('Loaded images from JS manifest:', allImages.length);
          } else {
              console.warn('window.manifestImages not found or empty.');
              // å…œåº•
              allImages = ['img/mountain-4847687_1920.jpg']; 
          }

          // å…ˆå¡«å……æ»¡å¯è§†åŒºåŸŸ
          console.log("Preloading initial images...");
          await fillQueue();
          
          // åˆå§‹é“ºæ»¡å±å¹•
          while (tailX < VIEWPORT_WIDTH + 100) {
               addNextItem();
               // å¦‚æœé˜Ÿåˆ—ç©ºäº†ä½†åœ¨åˆå§‹åŒ–é˜¶æ®µï¼Œåªèƒ½ç¡¬ç­‰ä¸€ä¸‹ fillQueue é‡Œçš„ promise
               // ç”±äºæ˜¯ async è¿™é‡Œä¸ä¼šé˜»å¡æ­»ï¼Œä½†ä¹Ÿéœ€è¦ç¡®ä¿é˜Ÿåˆ—æœ‰ä¸œè¥¿
               if (imageQueue.length === 0) await fillQueue();
          }

          // Start Animation
          requestAnimationFrame(loop);
      }
      
      initScenery();
    });
  </script>
  <section id="about" class="footnote">
    <div>Created By MchWang. | <a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener">é™•ICPå¤‡17021455å·</a></div>
  </section>
</body>
</html>
